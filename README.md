# GraphQL using Apollo Server and Express

Exercises from this book: https://www.robinwieruch.de/the-road-to-graphql-book
..and from this tutorial: https://www.robinwieruch.de/graphql-apollo-server-tutorial

Started with Simple Node Application: https://github.com/johnnyoshika/minimal-node-application

## Setup
* Use Node version 12.X (e.g. v12.16.1)
* `npm install`
* Postgres
  * `docker pull postgres`
  * `docker run --name graphql -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=docker -e POSTGRES_DB=apollo -d -p 5432:5432 postgres`
  * attach and use psql: `docker exec -it graphql psql -h localhost -U postgres -d apollo`
  * psql commands:
    * `\l` list databases
    * `\c {database name}` switch database
    * `\dt` list tables
    * `select * from users;` list users (only available after database is synced and seeded on application startup)
    * `select * from messages;` list messages (only available after database is synced and seeded on application startup)
    * `select * from messages where "text" like '%ultimate%';` this works
    * `select * from messages where text like '%ultimate%';` this also works
    * `select * from messages where "userId" = 1;` this works
    * `select * from messages where userId = 1;` this doesn't
    * `SELECT "id", "text", "createdAt", "updatedAt", "userId" FROM "messages" AS "message" WHERE "message"."id" = '5';` query generated by Sequelize
    * `\d messages` details about messages columns
    * <kbd>CTRL</kbd> <kbd>P</kbd> + <kbd>CTRL</kbd> <kbd>Q</kbd> -> quit
  * `docker stop graphql` stop container
  * `docker start graphql` start container
  * `docker rm graphql` remove container

## Run
* `docker start graphql`
* `npm start`
* Open http://localhost:8000/graphql

## Debugging in VS Code

Borrowed from: https://github.com/microsoft/vscode-recipes/tree/master/nodemon

_Note: Debugging works best after installing and running a long running task, such as **Express** web server. VS Code automatically re-attaches to a newly spanned Node process whenever files change, but because this default console app immediately ends its process, VS Code doesn't have enough time to re-attach reliably._

* Terminal:
  * `npm run debug`
* VS Code:
  * Go to the Debug view and select `Node: Nodemon` configuration
  * Start the debugger with <kbd>F5</kbd>
  * VS Code should list all of the running node processes. Select `nodemon --exec babel-node --inspect src/index.js` 
![image](https://user-images.githubusercontent.com/504505/77853652-0c17a580-719a-11ea-88f1-4fc02ddd568c.png)
  * Set a breakpoint and it should now be hit

## Deployment
* Install Heroku CLI: https://devcenter.heroku.com/articles/heroku-cli
* Log in to Heroku: `heroku login`
* Create Heroku application: `heroku create {unique name}` (e.g. `heroku create graphql-apollo-server11`)
* Install PostgreSQL: `heroku addons:create heroku-postgresql:hobby-dev`
* Prevent Heroku from pruning dev dependencies, because we need them, such as nodemon: `heroku config:set NPM_CONFIG_PRODUCTION=false YARN_PRODUCTION=false`
* Deploy: `git push heroku master`

_Note: May want to set `eraseDatabaseOnSync` to `false` after the first deployment so that the database isn't overwritten by re-seeding._

### Test Deployed App
* Open website: `heroku open`
  * ...then append `/graphql`
* Sign in:
  ```
  mutation {
    signIn(login:"louferigno", password:"1Password") {
      token
    }
  }
  ```
* Copy the token and add this to header:
  ```
  {
    "x-token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiZW1haWwiOiJsb3VAZW1haWwuY29tIiwidXNlcm5hbWUiOiJsb3VmZXJpZ25vIiwicm9sZSI6IkFETUlOIiwiaWF0IjoxNTg3NzcxMjQzLCJleHAiOjE1ODc3NzMwNDN9.8yL7p4roB9QtuKeF3kFfzNsKngk4lKywZjkiVUXkMks"
  }
  ```
* Open 2 browser tabs.
  * Tab 1:
    ```
    subscription {
      messageCreated {
        message {
          id
          text
          createdAt
          user {
            username
          }
        }
      }
    }
    ```
  * Tab 2:
    ```
    mutation {
      createMessage(text:"What are you doing today?") {
        text
        createdAt
      }
    }
    ```
  * _Note: The free tier at Heroku times out quickly, so the subscription won't remain connected for long._